<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🦎 크레스티드 게코 브리딩 시스템</title>
    
    <!-- PWA 설정 -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192x192.png">
    
    <!-- 외부 폰트 및 아이콘 -->
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        :root {
            /* 현대적인 색상 팔레트 */
            --primary: #3b82f6;
            --primary-light: #dbeafe;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-900: #111827;
            
            /* 글래스모피즘 */
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --backdrop-blur: blur(20px);
            
            /* 그림자 */
            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.05);
            --shadow-medium: 0 8px 30px rgba(0, 0, 0, 0.1);
            --shadow-strong: 0 20px 40px rgba(0, 0, 0, 0.15);
            
            /* 애니메이션 */
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, 
                rgba(59, 130, 246, 0.1) 0%, 
                rgba(168, 85, 247, 0.05) 25%,
                rgba(34, 197, 94, 0.08) 50%,
                rgba(244, 114, 182, 0.06) 75%,
                rgba(59, 130, 246, 0.1) 100%
            );
            min-height: 100vh;
            color: var(--gray-900);
            overflow-x: hidden;
        }
        
        /* 배경 애니메이션 */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(168, 85, 247, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(34, 197, 94, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
            animation: dreamFloat 20s ease-in-out infinite;
        }
        
        @keyframes dreamFloat {
            0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.8; }
            50% { transform: scale(1.1) rotate(180deg); opacity: 0.6; }
        }
        
        /* 글래스 카드 */
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: var(--shadow-soft);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-strong);
            background: rgba(255, 255, 255, 0.95);
        }
        
        /* 버튼 스타일 */
        .btn {
            padding: 12px 24px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 14px;
            transition: var(--transition);
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, #2563eb 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: var(--backdrop-blur);
            color: var(--gray-900);
            border: 1px solid var(--glass-border);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-2px);
        }
        
        /* 모달 */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: var(--backdrop-blur);
            border-radius: 25px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-strong);
            position: relative;
        }
        
        /* 입력 필드 */
        .input-field {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid rgba(229, 231, 235, 0.5);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.8);
            transition: var(--transition);
            font-size: 14px;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* 반응형 그리드 */
        .grid {
            display: grid;
            gap: 20px;
        }
        
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        
        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 { 
                grid-template-columns: 1fr; 
            }
        }
        
        /* 숨기기/보이기 */
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 통계 카드 */
        .stat-card {
            text-align: center;
            padding: 24px;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6b7280;
            font-weight: 500;
            margin-top: 8px;
        }
        
        /* 기능 카드 */
        .feature-card {
            padding: 24px;
            text-align: center;
            cursor: pointer;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .feature-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .feature-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 4px;
        }
        
        .feature-description {
            font-size: 0.85rem;
            color: #6b7280;
        }
        
        /* 이미지 업로드 스타일 */
        .image-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: rgba(249, 250, 251, 0.8);
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .image-upload-area:hover {
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.05);
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-soft);
            object-fit: cover;
        }
        
        .remove-image-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .remove-image-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }
        
        /* 모프 버튼 스타일 */
        .morph-btn {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            color: #3730a3;
            border: 1px solid #c7d2fe;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }
        
        .morph-btn:hover {
            background: linear-gradient(135deg, #c7d2fe 0%, #a5b4fc 100%);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }
        
        .morph-btn:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <!-- 헤더 -->
    <header class="p-6">
        <div class="max-w-7xl mx-auto">
            <div class="glass-card p-6">
                <h1 class="text-2xl font-bold text-center">
                    <span class="text-3xl mr-2">🦎</span>
                    크레스티드 게코 브리딩 시스템
                </h1>
                <p class="text-center text-gray-600 mt-2">
                    130마리 대량 관리 시스템 - 실시간 동기화 지원
                </p>
            </div>
        </div>
    </header>

    <!-- 메인 컨텐츠 -->
    <main class="max-w-7xl mx-auto px-6 pb-12">
        <!-- 통계 카드 -->
        <section class="mb-8">
            <div class="grid grid-4 mb-6">
                <div class="glass-card stat-card">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">총 개체</div>
                </div>
                <div class="glass-card stat-card">
                    <div class="stat-number" id="maleCount">0</div>
                    <div class="stat-label">수컷</div>
                </div>
                <div class="glass-card stat-card">
                    <div class="stat-number" id="femaleCount">0</div>
                    <div class="stat-label">암컷</div>
                </div>
                <div class="glass-card stat-card">
                    <div class="stat-number" id="babyCount">0</div>
                    <div class="stat-label">베이비</div>
                </div>
            </div>
        </section>

        <!-- 주요 기능 -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold mb-6">🚀 주요 기능</h2>
            <div class="grid grid-3">
                <div class="glass-card feature-card" onclick="showAnimalRegistrationModal()">
                    <div class="feature-icon">
                        <i class="fas fa-plus-circle"></i>
                    </div>
                    <div class="feature-title">개체 등록</div>
                    <div class="feature-description">새로운 게코 등록</div>
                </div>
                
                <div class="glass-card feature-card" onclick="showAnimalListModal()">
                    <div class="feature-icon">
                        <i class="fas fa-list"></i>
                    </div>
                    <div class="feature-title">개체 목록</div>
                    <div class="feature-description">등록된 개체 관리</div>
                </div>
                
                <div class="glass-card feature-card" onclick="showBabyModal()">
                    <div class="feature-icon">
                        <i class="fas fa-baby"></i>
                    </div>
                    <div class="feature-title">베이비 등록</div>
                    <div class="feature-description">새 베이비 추가</div>
                </div>
                
                <div class="glass-card feature-card" onclick="showBabyListModal()">
                    <div class="feature-icon">
                        <i class="fas fa-list-alt"></i>
                    </div>
                    <div class="feature-title">베이비 목록</div>
                    <div class="feature-description">베이비 관리 및 성장기록</div>
                </div>
                
                <div class="glass-card feature-card" onclick="showPedigreeModal()">
                    <div class="feature-icon">
                        <i class="fas fa-sitemap"></i>
                    </div>
                    <div class="feature-title">누대 관리</div>
                    <div class="feature-description">혈통 추적 및 가계도</div>
                </div>
                
                <!-- 임시 디버깅 버튼 -->
                <div class="glass-card feature-card" onclick="debugData()" style="background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%);">
                    <div class="feature-icon">
                        <i class="fas fa-bug"></i>
                    </div>
                    <div class="feature-title">🔧 디버그</div>
                    <div class="feature-description">데이터 상태 확인</div>
                </div>
            </div>
        </section>

        <!-- 고급 기능 -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold mb-6">⚡ 고급 기능</h2>
            <div class="grid grid-2">
                <div class="glass-card feature-card" onclick="showMorphCalculatorModal()">
                    <div class="feature-icon">
                        <i class="fas fa-calculator"></i>
                    </div>
                    <div class="feature-title">모프 계산기</div>
                    <div class="feature-description">유전 조합 예측</div>
                </div>
                
                <div class="glass-card feature-card" onclick="showBulkImportModal()">
                    <div class="feature-icon">
                        <i class="fas fa-file-import"></i>
                    </div>
                    <div class="feature-title">대량 가져오기</div>
                    <div class="feature-description">CSV/Excel 파일 가져오기</div>
                </div>
            </div>
        </section>
    </main>

    <!-- 모달 -->
    <div id="modalOverlay" class="modal-overlay hidden">
        <div class="modal-content">
            <div id="modalContent">
                <!-- 모달 내용이 동적으로 삽입됩니다 -->
            </div>
        </div>
    </div>

    <script>
        // 전역 데이터 저장소
        // 전역 변수 초기화 (안전한 배열 보장)
        let animals = [];
        let babies = [];
        
        // 전역 변수 보호 함수
        function ensureArrays() {
            if (!Array.isArray(animals)) {
                console.warn('⚠️ animals 배열 복구');
                animals = [];
            }
            if (!Array.isArray(babies)) {
                console.warn('⚠️ babies 배열 복구');
                babies = [];
            }
        }
        
        // 전역 오류 핸들러 추가
        window.addEventListener('error', function(event) {
            console.error('🚨 JavaScript 오류 발생:', event.error);
            console.error('파일:', event.filename);
            console.error('라인:', event.lineno);
            console.error('컬럼:', event.colno);
            
            // 배열 복구 시도
            ensureArrays();
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            console.error('🚨 Promise 오류 발생:', event.reason);
        });
        
        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            try {
                ensureArrays();
                loadData();
                updateStatistics();
                console.log('🦎 크레스티드 게코 시스템 초기화 완료!');
            } catch (error) {
                console.error('🚨 초기화 오류:', error);
                // 초기화 실패 시 기본 상태로
                animals = [];
                babies = [];
                updateStatistics();
            }
        });
        
        // 데이터 로드
        function loadData() {
            try {
                // 여러 키 형태 호환성 확보
                const animalKeys = ['geckoBreedingData', 'geckoAnimals'];
                const babyKeys = ['babies', 'geckoBabies'];
                
                // 동물 데이터 로드
                for (const key of animalKeys) {
                    const data = localStorage.getItem(key);
                    if (data) {
                        animals = JSON.parse(data);
                        break;
                    }
                }
                if (!Array.isArray(animals)) animals = [];
                
                // 베이비 데이터 로드
                for (const key of babyKeys) {
                    const data = localStorage.getItem(key);
                    if (data) {
                        try {
                            babies = JSON.parse(data);
                            if (Array.isArray(babies)) break;
                        } catch (error) {
                            console.error(`데이터 로드 오류 (${key}):`, error);
                        }
                    }
                }
                if (!Array.isArray(babies)) babies = [];
                
                updateStatistics();
                console.log(`📊 데이터 로드 완료: 개체 ${animals.length}마리, 베이비 ${babies.length}마리`);
                
            } catch (error) {
                console.error('데이터 로드 오류:', error);
                animals = [];
                babies = [];
            }
        }
        
        // 데이터 저장 (통합 키 사용)
        function saveData() {
            try {
                // 데이터 유효성 검증
                if (!Array.isArray(animals)) {
                    console.warn('⚠️ animals가 배열이 아님, 수정중...');
                    animals = [];
                }
                
                if (!Array.isArray(babies)) {
                    console.warn('⚠️ babies가 배열이 아님, 수정중...');
                    babies = [];
                }
                
                // 표준 키로 저장
                localStorage.setItem('geckoBreedingData', JSON.stringify(animals));
                localStorage.setItem('babies', JSON.stringify(babies));
                
                // 호환성을 위해 기존 키도 유지
                localStorage.setItem('geckoAnimals', JSON.stringify(animals));
                localStorage.setItem('geckoBabies', JSON.stringify(babies));
                
                updateStatistics();
                console.log(`💾 데이터 저장 완료 - 개체: ${animals.length}마리, 베이비: ${babies.length}마리`);
                
            } catch (error) {
                console.error('❌ 데이터 저장 실패:', error);
                
                if (error.name === 'QuotaExceededError') {
                    showToast('저장 공간이 부족합니다. 불필요한 데이터를 정리해주세요.', 'error');
                    // 자동 압축 시도
                    if (window.bulkDataManager && window.bulkDataManager.compressAndSave) {
                        console.log('🗜️ 자동 데이터 압축 시도...');
                        window.bulkDataManager.compressAndSave();
                    }
                } else {
                    showToast('데이터 저장에 실패했습니다: ' + error.message, 'error');
                }
            }
        }
        
        // 통계 업데이트
        function updateStatistics() {
            const total = animals.length + babies.length;
            const males = animals.filter(a => a.gender === '수컷').length;
            const females = animals.filter(a => a.gender === '암컷').length;
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('maleCount').textContent = males;
            document.getElementById('femaleCount').textContent = females;
            document.getElementById('babyCount').textContent = babies.length;
        }
        
        // 모달 열기/닫기
        function openModal() {
            const modalOverlay = document.getElementById('modalOverlay');
            if (modalOverlay) {
                modalOverlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            } else {
                console.error('❌ 모달 오버레이 요소를 찾을 수 없습니다.');
            }
        }
        
        function closeModal() {
            const modalOverlay = document.getElementById('modalOverlay');
            if (modalOverlay) {
                modalOverlay.classList.add('hidden');
                document.body.style.overflow = 'auto';
            } else {
                console.error('❌ 모달 오버레이 요소를 찾을 수 없습니다.');
            }
        }
        
        // ESC 키로 모달 닫기
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeModal();
        });
        
        // 모달 배경 클릭으로 닫기
        document.getElementById('modalOverlay').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
        
        // 개체 등록 모달
        function showAnimalRegistrationModal() {
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold flex items-center gap-2">
                            <i class="fas fa-plus-circle text-blue-500"></i>
                            개체 등록
                        </h2>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form onsubmit="registerAnimal(event)" class="space-y-6">
                        <!-- 기본 정보 -->
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                <i class="fas fa-id-card text-green-500"></i>
                                기본 정보
                            </h3>
                            <div class="grid grid-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 flex items-center justify-between">
                                        개체 이름 *
                                        <button type="button" onclick="generateAnimalId()" class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 transition-colors" title="자동 ID 생성">
                                            <i class="fas fa-magic"></i> 자동생성
                                        </button>
                                    </label>
                                    <input type="text" id="animalName" class="input-field" required
                                           placeholder="예: Luna-01, Dragon-23">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">성별 *</label>
                                    <select id="animalGender" class="input-field" required onchange="updateAnimalPreview()">
                                        <option value="">성별 선택</option>
                                        <option value="수컷">🔵 수컷 (Male)</option>
                                        <option value="암컷">🔴 암컷 (Female)</option>
                                        <option value="미구분">⚪ 미구분 (Unknown)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 유전 정보 -->
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                <i class="fas fa-dna text-blue-500"></i>
                                유전 정보
                            </h3>
                            <div class="grid grid-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">세대</label>
                                    <select id="animalGeneration" class="input-field">
                                        <option value="F1">F1 - 1세대</option>
                                        <option value="F2">F2 - 2세대</option>
                                        <option value="F3">F3 - 3세대</option>
                                        <option value="F4">F4 - 4세대</option>
                                        <option value="F5+">F5+ - 5세대 이상</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">모프 (Morph)</label>
                                    <input type="text" id="animalMorph" class="input-field"
                                           placeholder="예: 릴리화이트, 달마시안, 하를퀸..."
                                           oninput="showMorphSuggestions(this.value)"
                                           onfocus="showPopularMorphs()">
                                    
                                    <!-- 인기 모프 빠른 선택 -->
                                    <div id="popularMorphs" class="mt-2 flex flex-wrap gap-1 hidden">
                                        <button type="button" onclick="selectMorph('Normal')" class="morph-btn">Normal</button>
                                        <button type="button" onclick="selectMorph('릴리화이트')" class="morph-btn">릴리화이트</button>
                                        <button type="button" onclick="selectMorph('달마시안')" class="morph-btn">달마시안</button>
                                        <button type="button" onclick="selectMorph('하를퀸')" class="morph-btn">하를퀸</button>
                                        <button type="button" onclick="selectMorph('트라이컬러')" class="morph-btn">트라이컬러</button>
                                        <button type="button" onclick="selectMorph('파이어')" class="morph-btn">파이어</button>
                                        <button type="button" onclick="selectMorph('크림')" class="morph-btn">크림</button>
                                        <button type="button" onclick="selectMorph('오렌지')" class="morph-btn">오렌지</button>
                                    </div>
                                    
                                    <!-- 자동완성 제안 -->
                                    <div id="morphSuggestions" class="mt-1 bg-white border border-gray-300 rounded-lg shadow-lg hidden max-h-32 overflow-y-auto"></div>
                                </div>
                            </div>
                            <div class="grid grid-2 gap-4 mt-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">출생일</label>
                                    <input type="date" id="animalBirthDate" class="input-field" 
                                           value="${new Date().toISOString().split('T')[0]}">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">현재 체중 (g)</label>
                                    <input type="number" id="animalWeight" class="input-field" step="0.1"
                                           placeholder="예: 45.5">
                                </div>
                            </div>
                        </div>
                        
                        <!-- 개체 이미지 -->
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                <i class="fas fa-camera text-green-500"></i>
                                개체 사진
                            </h3>
                            <div class="image-upload-area" onclick="document.getElementById('animalImageInput').click()">
                                <input type="file" id="animalImageInput" accept="image/*" style="display:none" onchange="previewAnimalImage(this)">
                                <div id="animalImagePreview" style="display:none">
                                    <img id="animalPreviewImg" class="preview-image">
                                    <button type="button" onclick="removeAnimalImage()" class="remove-image-btn">
                                        <i class="fas fa-trash"></i> 이미지 삭제
                                    </button>
                                </div>
                                <div id="animalImageUploader">
                                    <i class="fas fa-camera text-4xl text-gray-400 mb-2"></i>
                                    <p class="text-gray-600 font-medium">개체 사진 추가</p>
                                    <p class="text-sm text-gray-500 mt-1">클릭하여 이미지 선택 (JPG, PNG 지원)</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 추가 정보 -->
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                <i class="fas fa-info-circle text-purple-500"></i>
                                추가 정보
                            </h3>
                            <div class="grid grid-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">획득일</label>
                                    <input type="date" id="animalDate" class="input-field" 
                                           value="${new Date().toISOString().split('T')[0]}">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">상태</label>
                                    <select id="animalStatus" class="input-field">
                                        <option value="활성">✅ 활성 (Active)</option>
                                        <option value="판매됨">💰 판매됨 (Sold)</option>
                                        <option value="교배중">❤️ 교배중 (Breeding)</option>
                                        <option value="비활성">⏸️ 비활성 (Inactive)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium mb-2">메모</label>
                                <textarea id="animalNotes" class="input-field" rows="3"
                                          placeholder="개체에 대한 특이사항이나 메모..."></textarea>
                            </div>
                        </div>
                        
                        <!-- 버튼 -->
                        <div class="flex gap-3">
                            <button type="button" onclick="closeModal()" class="btn btn-secondary flex-1">
                                <i class="fas fa-times"></i> 취소
                            </button>
                            <button type="submit" class="btn btn-primary flex-1">
                                <i class="fas fa-plus"></i> 개체 등록
                            </button>
                        </div>
                    </form>
                </div>
            `;
            openModal();
        }
        
        // 모프별 고유 영어 약어 매핑
        const morphCodes = {
            // 기본 모프
            'Normal': 'NOR',
            'normal': 'NOR',
            '노멀': 'NOR',
            
            // 릴리화이트 계열
            'Lily White': 'LW',
            'LilyWhite': 'LW', 
            'Lilly White': 'LW',
            '릴리화이트': 'LW',
            '릴리 화이트': 'LW',
            
            // 달마시안 계열
            'Dalmatian': 'DAL',
            'dalmatian': 'DAL',
            '달마시안': 'DAL',
            
            // 하를퀸 계열
            'Harlequin': 'HAR',
            'harlequin': 'HAR',
            '하를퀸': 'HAR',
            
            // 트라이컬러
            'Tri Color': 'TRI',
            'Tricolor': 'TRI',
            'Tri-Color': 'TRI',
            '트라이컬러': 'TRI',
            
            // 파이어
            'Fire': 'FIR',
            'fire': 'FIR',
            '파이어': 'FIR',
            
            // 크림
            'Cream': 'CRM',
            'cream': 'CRM',
            '크림': 'CRM',
            
            // 오렌지
            'Orange': 'ORG',
            'orange': 'ORG',
            '오렌지': 'ORG',
            
            // 레드
            'Red': 'RED',
            'red': 'RED',
            '레드': 'RED',
            
            // 엘로우
            'Yellow': 'YEL',
            'yellow': 'YEL',
            '옐로우': 'YEL',
            '노랑': 'YEL',
            
            // 플레임
            'Flame': 'FLA',
            'flame': 'FLA',
            '플레임': 'FLA',
            
            // 패턴드
            'Patterned': 'PAT',
            'patterned': 'PAT',
            '패턴드': 'PAT',
            
            // 고스트
            'Ghost': 'GHO',
            'ghost': 'GHO',
            '고스트': 'GHO',
            
            // 바이컬러
            'Bi-Color': 'BIC',
            'Bicolor': 'BIC',
            '바이컬러': 'BIC'
        };
        
        // 모프 코드 가져오기 함수
        function getMorphCode(morphInput) {
            // 정확히 일치하는 것부터 찾기
            if (morphCodes[morphInput]) {
                return morphCodes[morphInput];
            }
            
            // 대소문자 구분 없이 찾기
            const lowerInput = morphInput.toLowerCase();
            for (const [key, value] of Object.entries(morphCodes)) {
                if (key.toLowerCase() === lowerInput) {
                    return value;
                }
            }
            
            // 부분 일치 찾기
            for (const [key, value] of Object.entries(morphCodes)) {
                if (key.toLowerCase().includes(lowerInput) || lowerInput.includes(key.toLowerCase())) {
                    return value;
                }
            }
            
            // 없으면 첫 3글자 대문자로
            return morphInput.substring(0, 3).toUpperCase() || 'UNK';
        }
        
        // 개체 자동 ID 생성 함수 (개선됨)
        function generateAnimalId() {
            const gender = document.getElementById('animalGender').value;
            const morphInput = document.getElementById('animalMorph').value || 'Normal';
            
            if (!gender) {
                showToast('먼저 성별을 선택해주세요!', 'warning');
                return;
            }
            
            // 성별별 접두사
            const genderPrefix = {
                '수컷': 'M',
                '암컷': 'F', 
                '미구분': 'U'
            };
            
            // 모프 코드 가져오기
            const morphCode = getMorphCode(morphInput);
            
            // 현재 날짜
            const now = new Date();
            const year = now.getFullYear().toString().slice(-2);
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            
            // 같은 모프의 기존 개체 수 확인
            const sameGenderMorphCount = animals.filter(a => 
                a.gender === gender && getMorphCode(a.morph || 'Normal') === morphCode
            ).length;
            const count = (sameGenderMorphCount + 1).toString().padStart(2, '0');
            
            // 자동 ID 생성: YYMMGenderMorphCode-Count
            const genderChar = genderPrefix[gender];
            const autoId = `${year}${month}${genderChar}${morphCode}-${count}`;
            
            document.getElementById('animalName').value = autoId;
            showToast(`모프 "${morphInput}" → 코드 "${morphCode}"로 ID 생성!`, 'success');
        }
        
        // 개체 미리보기 업데이트 함수
        function updateAnimalPreview() {
            // 추후 개체 미리보기 기능을 위한 함수
            console.log('개체 미리보기 업데이트');
        }
        
        // 개체 이미지 미리보기 함수
        function previewAnimalImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('animalPreviewImg').src = e.target.result;
                    document.getElementById('animalImagePreview').style.display = 'block';
                    document.getElementById('animalImageUploader').style.display = 'none';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // 개체 이미지 제거 함수
        function removeAnimalImage() {
            document.getElementById('animalImageInput').value = '';
            document.getElementById('animalImagePreview').style.display = 'none';
            document.getElementById('animalImageUploader').style.display = 'block';
        }
        
        // 개체 등록 함수
        async function registerAnimal(event) {
            event.preventDefault();
            
            const imageInput = document.getElementById('animalImageInput');
            
            // 이미지 처리
            let imageData = null;
            if (imageInput.files && imageInput.files[0]) {
                try {
                    showToast('이미지 처리 중...', 'info');
                    imageData = await compressImage(imageInput.files[0]);
                } catch (error) {
                    console.error('이미지 처리 실패:', error);
                    showToast('이미지 처리에 실패했습니다. 계속 진행합니다.', 'warning');
                }
            }
            
            const newAnimal = {
                id: Date.now().toString(),
                name: document.getElementById('animalName').value,
                gender: document.getElementById('animalGender').value,
                generation: document.getElementById('animalGeneration').value || 'F1',
                morph: document.getElementById('animalMorph').value || 'Normal',
                birthDate: document.getElementById('animalBirthDate').value,
                weight: document.getElementById('animalWeight').value || '',
                date: document.getElementById('animalDate').value || new Date().toISOString().split('T')[0],
                status: document.getElementById('animalStatus').value || '활성',
                notes: document.getElementById('animalNotes').value || '',
                imageData: imageData, // 개체 이미지 추가
                createdAt: new Date().toISOString(),
                // 자동으로 건강 기록 초기화
                healthRecords: [],
                // 교배 이력 초기화  
                breedingHistory: []
            };
            
            animals.push(newAnimal);
            saveData();
            
            // UI 업데이트
            updateStatistics();
            
            // Firebase 동기화
            if (window.firebaseSync && window.firebaseSync.isInitialized) {
                window.firebaseSync.saveToCloud('animals', animals);
            }
            
            closeModal();
            
            // 성공 메시지
            showToast(`${newAnimal.name} 개체가 등록되었습니다!`, 'success');
            
            console.log('새 개체 등록:', newAnimal);
            
            // 0.5초 후 개체 목록 모달 자동 표시
            setTimeout(() => {
                showAnimalListModal();
            }, 500);
        }
        
        // 개체 목록 모달
        function showAnimalListModal() {
            const modalContent = document.getElementById('modalContent');
            let listHTML = '';
            
            if (animals.length === 0) {
                listHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">등록된 개체가 없습니다</p>
                        <button onclick="closeModal(); showAnimalRegistrationModal();" class="btn btn-primary mt-4">
                            <i class="fas fa-plus"></i> 첫 개체 등록하기
                        </button>
                    </div>
                `;
            } else {
                listHTML = `
                    <div class="grid gap-4">
                        ${animals.map(animal => `
                            <div class="glass-card p-4 hover:bg-white/50 transition-colors">
                                <div class="flex gap-4">
                                    <!-- 개체 이미지 -->
                                    <div class="flex-shrink-0">
                                        ${animal.imageData ? 
                                            `<img src="${animal.imageData}" alt="${animal.name}" class="w-20 h-20 object-cover rounded-lg border-2 border-gray-200">` :
                                            `<div class="w-20 h-20 bg-gray-100 rounded-lg border-2 border-gray-200 flex items-center justify-center">
                                                <i class="fas fa-camera text-gray-400 text-lg"></i>
                                            </div>`
                                        }
                                    </div>
                                    
                                    <!-- 개체 정보 -->
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-lg">${animal.name}</h4>
                                        <div class="text-sm text-gray-600 mt-1">
                                            <span class="mr-4">${animal.gender} • ${animal.generation}</span>
                                            <span class="text-gray-500">${animal.morph}</span>
                                        </div>
                                        <div class="text-sm text-gray-500 mt-1">
                                            등록일: ${animal.date}
                                            ${animal.weight ? ` • 체중: ${animal.weight}g` : ''}
                                        </div>
                                        ${animal.notes ? `<p class="text-sm text-gray-600 mt-1">${animal.notes}</p>` : ''}
                                    </div>
                                    
                                    <!-- 상태 및 액션 -->
                                    <div class="text-right flex-shrink-0">
                                        <span class="inline-block px-2 py-1 ${animal.status === '활성' ? 'bg-green-100 text-green-800' : 
                                                                              animal.status === '교배중' ? 'bg-pink-100 text-pink-800' : 
                                                                              animal.status === '판매됨' ? 'bg-yellow-100 text-yellow-800' : 
                                                                              'bg-gray-100 text-gray-800'} text-xs rounded-full mb-2">
                                            ${animal.status}
                                        </span>
                                        <div class="flex flex-col gap-1">
                                            <button onclick="showAnimalDetails('${animal.id}')" 
                                                    class="text-xs text-blue-600 hover:text-blue-800 px-2 py-1 rounded">
                                                상세보기
                                            </button>
                                            <button onclick="editAnimal('${animal.id}')" 
                                                    class="text-xs text-green-600 hover:text-green-800 px-2 py-1 rounded">
                                                편집
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            modalContent.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold flex items-center gap-2">
                            <i class="fas fa-list text-blue-500"></i>
                            개체 목록 (${animals.length}마리)
                        </h2>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    ${listHTML}
                </div>
            `;
            openModal();
        }
        
        // 개체 상세 정보 모달
        function showAnimalDetails(animalId) {
            const animal = animals.find(a => a.id === animalId);
            if (!animal) {
                showToast('개체를 찾을 수 없습니다!', 'error');
                return;
            }
            
            const modalContent = document.getElementById('modalContent');
            
            // 나이 계산
            const birthDate = animal.birthDate || animal.date;
            const age = birthDate ? Math.floor((new Date() - new Date(birthDate)) / (1000 * 60 * 60 * 24 * 365.25)) : '?';
            const ageInDays = birthDate ? Math.floor((new Date() - new Date(birthDate)) / (1000 * 60 * 60 * 24)) : '?';
            
            // 자손 찾기 (베이비 중에서)
            const offspring = babies.filter(baby => 
                baby.fatherId === animal.id || baby.motherId === animal.id
            );
            
            modalContent.innerHTML = `
                <div class="p-6 max-w-2xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold flex items-center gap-2">
                            ${animal.gender === '수컷' ? '<i class="fas fa-mars text-blue-500"></i>' : 
                              animal.gender === '암컷' ? '<i class="fas fa-venus text-pink-500"></i>' : 
                              '<i class="fas fa-question text-gray-500"></i>'}
                            ${animal.name} 상세 정보
                        </h2>
                        <button onclick="showAnimalListModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <!-- 기본 정보 -->
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                <i class="fas fa-info-circle text-blue-500"></i>
                                기본 정보
                            </h3>
                            
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="font-medium">이름:</span>
                                    <span>${animal.name}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium">성별:</span>
                                    <span class="flex items-center gap-1">
                                        ${animal.gender === '수컷' ? '<i class="fas fa-mars text-blue-500"></i>' : 
                                          animal.gender === '암컷' ? '<i class="fas fa-venus text-pink-500"></i>' : 
                                          '<i class="fas fa-question text-gray-500"></i>'}
                                        ${animal.gender}
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium">세대:</span>
                                    <span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded-full">
                                        ${animal.generation || 'F1'}
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium">모프:</span>
                                    <span class="font-semibold text-purple-600">${animal.morph || 'Normal'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium">상태:</span>
                                    <span class="px-2 py-1 ${animal.status === '활성' ? 'bg-green-100 text-green-800' : 
                                                            animal.status === '교배중' ? 'bg-pink-100 text-pink-800' : 
                                                            animal.status === '판매됨' ? 'bg-yellow-100 text-yellow-800' : 
                                                            'bg-gray-100 text-gray-800'} text-xs rounded-full">
                                        ${animal.status || '활성'}
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium">체중:</span>
                                    <span>${animal.weight ? animal.weight + 'g' : '미기록'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium">생년월일:</span>
                                    <span>${birthDate || '미기록'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium">나이:</span>
                                    <span>${age}세 (${ageInDays}일)</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium">등록일:</span>
                                    <span>${animal.createdAt ? new Date(animal.createdAt).toLocaleString() : (animal.date || '미기록')}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 사진 -->
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                <i class="fas fa-camera text-green-500"></i>
                                사진
                            </h3>
                            
                            <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden">
                                ${animal.imageData ? 
                                    `<img src="${animal.imageData}" alt="${animal.name}" class="w-full h-full object-cover">` :
                                    `<div class="w-full h-full flex items-center justify-center text-gray-400">
                                        <div class="text-center">
                                            <i class="fas fa-camera text-4xl mb-2"></i>
                                            <p>사진 없음</p>
                                        </div>
                                    </div>`
                                }
                            </div>
                        </div>
                        
                        <!-- 자손 정보 -->
                        ${offspring.length > 0 ? `
                        <div class="glass-card p-6 md:col-span-2">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                <i class="fas fa-baby text-pink-500"></i>
                                자손 정보 (${offspring.length}마리)
                            </h3>
                            
                            <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
                                ${offspring.map(baby => {
                                    const babyAge = Math.floor((new Date() - new Date(baby.hatchDate)) / (1000 * 60 * 60 * 24));
                                    const partner = baby.fatherId === animal.id ? 
                                        animals.find(a => a.id === baby.motherId)?.name || '알 수 없음' :
                                        animals.find(a => a.id === baby.fatherId)?.name || '알 수 없음';
                                    
                                    return `
                                        <div class="bg-white p-3 rounded-lg border">
                                            <div class="font-medium text-sm">${baby.name || baby.babyId}</div>
                                            <div class="text-xs text-gray-500 mt-1">
                                                상대: ${partner}<br>
                                                해칭: ${baby.hatchDate} (${babyAge}일)<br>
                                                체중: ${baby.weight || '미기록'}g
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- 메모 -->
                        ${animal.notes ? `
                        <div class="glass-card p-6 md:col-span-2">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                <i class="fas fa-sticky-note text-yellow-500"></i>
                                메모
                            </h3>
                            <p class="text-gray-700 leading-relaxed">${animal.notes}</p>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- 액션 버튼 -->
                    <div class="flex gap-3 mt-6">
                        <button onclick="showAnimalListModal()" class="btn btn-secondary flex-1">
                            <i class="fas fa-arrow-left"></i> 목록으로
                        </button>
                        <button onclick="editAnimal('${animal.id}')" class="btn btn-primary flex-1">
                            <i class="fas fa-edit"></i> 편집
                        </button>
                    </div>
                </div>
            `;
        }
        
        // 베이비 상세 정보 모달
        function showBabyDetails(babyId) {
            const baby = babies.find(b => b.id === babyId);
            if (!baby) {
                showToast('베이비를 찾을 수 없습니다!', 'error');
                return;
            }
            
            const modalContent = document.getElementById('modalContent');
            
            // 부모 정보 찾기
            const father = animals.find(a => a.id === baby.fatherId);
            const mother = animals.find(a => a.id === baby.motherId);
            
            // 나이 계산
            const age = Math.floor((new Date() - new Date(baby.hatchDate)) / (1000 * 60 * 60 * 24));
            const weeks = Math.floor(age / 7);
            
            // 최신 체중 찾기
            let currentWeight = baby.weight || 0;
            if (baby.growthRecords && baby.growthRecords.length > 0) {
                const latestRecord = baby.growthRecords
                    .filter(r => r.weight && parseFloat(r.weight) > 0)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                if (latestRecord) currentWeight = latestRecord.weight;
            }
            
            modalContent.innerHTML = `
                <div class="p-6 max-w-2xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold flex items-center gap-2">
                            <i class="fas fa-baby text-pink-500"></i>
                            ${baby.name || baby.babyId} 상세 정보
                        </h2>
                        <button onclick="showBabyListModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <!-- 기본 정보 -->
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                <i class="fas fa-info-circle text-blue-500"></i>
                                기본 정보
                            </h3>
                            
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="font-medium">이름:</span>
                                    <span>${baby.name || baby.babyId}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium">고유 ID:</span>
                                    <span class="text-xs text-gray-500">${baby.babyId}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium">성별:</span>
                                    <div class="flex items-center gap-2">
                                        <span class="flex items-center gap-1">
                                            ${baby.gender === '수컷' ? '<i class="fas fa-mars text-blue-500"></i> 수컷' : 
                                              baby.gender === '암컷' ? '<i class="fas fa-venus text-pink-500"></i> 암컷' : 
                                              '<i class="fas fa-question text-gray-500"></i> 미구분'}
                                        </span>
                                        <button onclick="updateBabyGender('${baby.id}')" class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                            변경
                                        </button>
                                    </div>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium">모프:</span>
                                    <span class="font-semibold text-purple-600">${baby.morph || 'TBD'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium">상태:</span>
                                    <div class="flex items-center gap-2">
                                        <span class="px-2 py-1 ${baby.status === '베이비' ? 'bg-pink-100 text-pink-800' : 
                                                                baby.status === '분양됨' ? 'bg-green-100 text-green-800' : 
                                                                baby.status === '폐사' ? 'bg-red-100 text-red-800' : 
                                                                'bg-gray-100 text-gray-800'} text-xs rounded-full">
                                            ${baby.status || '베이비'}
                                        </span>
                                        <button onclick="updateBabyStatus('${baby.id}')" class="text-xs px-2 py-1 bg-orange-100 text-orange-700 rounded hover:bg-orange-200">
                                            변경
                                        </button>
                                    </div>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium">현재 체중:</span>
                                    <span class="font-semibold">${currentWeight}g</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium">해칭일:</span>
                                    <span>🥚 ${baby.hatchDate}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-medium">나이:</span>
                                    <span>${age}일 (${weeks}주)</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 사진 -->
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                <i class="fas fa-camera text-green-500"></i>
                                사진
                            </h3>
                            
                            <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden">
                                ${baby.imageData ? 
                                    `<img src="${baby.imageData}" alt="${baby.name || baby.babyId}" class="w-full h-full object-cover">` :
                                    `<div class="w-full h-full flex items-center justify-center text-gray-400">
                                        <div class="text-center">
                                            <i class="fas fa-camera text-4xl mb-2"></i>
                                            <p>사진 없음</p>
                                        </div>
                                    </div>`
                                }
                            </div>
                        </div>
                        
                        <!-- 부모 정보 -->
                        <div class="glass-card p-6 md:col-span-2">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                <i class="fas fa-users text-purple-500"></i>
                                부모 정보
                            </h3>
                            
                            <div class="grid sm:grid-cols-2 gap-4">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h4 class="font-medium flex items-center gap-2 mb-2">
                                        <i class="fas fa-mars text-blue-500"></i>
                                        아버지
                                    </h4>
                                    <p class="font-semibold">${father ? father.name : '알 수 없음'}</p>
                                    ${father ? `<p class="text-sm text-gray-600">${father.morph || 'Normal'} • ${father.generation || 'F1'}</p>` : ''}
                                </div>
                                <div class="bg-pink-50 p-4 rounded-lg">
                                    <h4 class="font-medium flex items-center gap-2 mb-2">
                                        <i class="fas fa-venus text-pink-500"></i>
                                        어머니
                                    </h4>
                                    <p class="font-semibold">${mother ? mother.name : '알 수 없음'}</p>
                                    ${mother ? `<p class="text-sm text-gray-600">${mother.morph || 'Normal'} • ${mother.generation || 'F1'}</p>` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <!-- 성장 기록 요약 -->
                        ${baby.growthRecords && baby.growthRecords.length > 0 ? `
                        <div class="glass-card p-6 md:col-span-2">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                <i class="fas fa-chart-line text-green-500"></i>
                                성장 기록 (${baby.growthRecords.length}개)
                            </h3>
                            
                            <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
                                ${baby.growthRecords
                                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                                    .slice(0, 6)
                                    .map(record => `
                                        <div class="bg-white p-3 rounded-lg border">
                                            <div class="font-medium text-sm">${record.milestone || '기록'}</div>
                                            <div class="text-xs text-gray-500 mt-1">
                                                날짜: ${record.date}<br>
                                                체중: ${record.weight || '미기록'}g
                                                ${record.notes ? `<br>메모: ${record.notes.substring(0, 30)}${record.notes.length > 30 ? '...' : ''}` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- 메모 -->
                        ${baby.notes ? `
                        <div class="glass-card p-6 md:col-span-2">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                <i class="fas fa-sticky-note text-yellow-500"></i>
                                메모
                            </h3>
                            <p class="text-gray-700 leading-relaxed">${baby.notes}</p>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- 액션 버튼 -->
                    <div class="flex gap-3 mt-6">
                        <button onclick="showBabyListModal()" class="btn btn-secondary flex-1">
                            <i class="fas fa-arrow-left"></i> 목록으로
                        </button>
                        <button onclick="showBabyGrowthModal('${baby.id}')" class="btn btn-success flex-1">
                            <i class="fas fa-chart-line"></i> 성장기록
                        </button>
                        <button onclick="promoteToF2('${baby.id}')" class="btn btn-primary flex-1">
                            <i class="fas fa-arrow-up"></i> F2 승격
                        </button>
                    </div>
                </div>
            `;
        }
        
        // 베이비 성별 변경
        function updateBabyGender(babyId) {
            const baby = babies.find(b => b.id === babyId);
            if (!baby) return;
            
            const currentGender = baby.gender || '미구분';
            const genderOptions = ['미구분', '수컷', '암컷'];
            const currentIndex = genderOptions.indexOf(currentGender);
            
            const newGender = genderOptions[(currentIndex + 1) % genderOptions.length];
            
            if (confirm(`${baby.name || baby.babyId}의 성별을 "${newGender}"로 변경하시겠습니까?`)) {
                baby.gender = newGender;
                baby.updatedAt = new Date().toISOString();
                
                saveData();
                showBabyDetails(babyId); // 모달 새로고침
                showToast(`성별이 "${newGender}"로 변경되었습니다.`, 'success');
            }
        }
        
        // 베이비 상태 변경
        function updateBabyStatus(babyId) {
            const baby = babies.find(b => b.id === babyId);
            if (!baby) return;
            
            const statusOptions = [
                { value: '베이비', label: '베이비', color: 'bg-pink-100 text-pink-800' },
                { value: '분양됨', label: '분양됨', color: 'bg-green-100 text-green-800' },
                { value: '폐사', label: '폐사', color: 'bg-red-100 text-red-800' }
            ];
            
            const optionsHTML = statusOptions.map(option => 
                `<button onclick="setBabyStatus('${babyId}', '${option.value}')" 
                         class="w-full px-4 py-2 text-left hover:bg-gray-50 ${option.color} mb-1 rounded">
                    ${option.label}
                </button>`
            ).join('');
            
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <div class="p-6 max-w-md mx-auto">
                    <h3 class="text-lg font-semibold mb-4">상태 변경</h3>
                    <p class="text-gray-600 mb-4">${baby.name || baby.babyId}의 상태를 선택해주세요:</p>
                    <div class="space-y-2">
                        ${optionsHTML}
                    </div>
                    <button onclick="showBabyDetails('${babyId}')" class="btn btn-secondary w-full mt-4">
                        취소
                    </button>
                </div>
            `;
        }
        
        // 베이비 상태 설정
        function setBabyStatus(babyId, newStatus) {
            const baby = babies.find(b => b.id === babyId);
            if (!baby) return;
            
            baby.status = newStatus;
            baby.updatedAt = new Date().toISOString();
            
            // 폐사 시 추가 정보
            if (newStatus === '폐사') {
                const deathDate = prompt('폐사일을 입력해주세요 (YYYY-MM-DD 형식):');
                if (deathDate) {
                    baby.deathDate = deathDate;
                }
                const cause = prompt('폐사 원인을 입력해주세요 (선택사항):');
                if (cause) {
                    baby.notes = (baby.notes || '') + `\\n폐사 원인: ${cause}`;
                }
            }
            
            // 분양 시 추가 정보
            if (newStatus === '분양됨') {
                const adoptionDate = prompt('분양일을 입력해주세요 (YYYY-MM-DD 형식):');
                if (adoptionDate) {
                    baby.adoptionDate = adoptionDate;
                }
            }
            
            saveData();
            showBabyDetails(babyId);
            showToast(`상태가 "${newStatus}"로 변경되었습니다.`, 'success');
        }
        
        // 베이비 등록 모달
        function showBabyModal() {
            const modalContent = document.getElementById('modalContent');
            
            // 부모 개체 목록 (성체만)
            const maleAnimals = animals.filter(a => a.gender === '수컷' && a.status === '활성');
            const femaleAnimals = animals.filter(a => a.gender === '암컷' && a.status === '활성');
            
            let maleOptions = '<option value="">🔵 부개체 선택 (수컷)</option>';
            maleAnimals.forEach(animal => {
                const birthYear = animal.birthDate ? new Date(animal.birthDate).getFullYear() : (animal.date ? new Date(animal.date).getFullYear() : '?');
                const age = animal.birthDate ? Math.floor((new Date() - new Date(animal.birthDate)) / (1000 * 60 * 60 * 24 * 365.25)) : '?';
                maleOptions += `<option value="${animal.id}">🔵 ${animal.name} | ${animal.morph || 'Normal'} | ${birthYear}년생 (${age}세) ${animal.generation ? `| ${animal.generation}` : ''}</option>`;
            });
            
            let femaleOptions = '<option value="">🔴 모개체 선택 (암컷)</option>';
            femaleAnimals.forEach(animal => {
                const birthYear = animal.birthDate ? new Date(animal.birthDate).getFullYear() : (animal.date ? new Date(animal.date).getFullYear() : '?');
                const age = animal.birthDate ? Math.floor((new Date() - new Date(animal.birthDate)) / (1000 * 60 * 60 * 24 * 365.25)) : '?';
                femaleOptions += `<option value="${animal.id}">🔴 ${animal.name} | ${animal.morph || 'Normal'} | ${birthYear}년생 (${age}세) ${animal.generation ? `| ${animal.generation}` : ''}</option>`;
            });
            
            modalContent.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold flex items-center gap-2">
                            <i class="fas fa-baby text-pink-500"></i>
                            베이비 등록
                        </h2>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form onsubmit="registerBaby(event)" class="space-y-6">
                        <!-- 부모 정보 -->
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                <i class="fas fa-users text-pink-500"></i>
                                부모 정보 선택
                            </h3>
                            
                            <!-- 부개체 선택 -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">🔵 부개체 (수컷) *</label>
                                <select id="babyFather" class="input-field" required onchange="updateParentPreview('father')">
                                    ${maleOptions}
                                </select>
                                <div id="fatherPreview" class="mt-2 p-3 bg-blue-50 rounded-lg hidden">
                                    <div class="flex items-center gap-3">
                                        <div id="fatherImage" class="w-12 h-12 bg-gray-200 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-male text-blue-500"></i>
                                        </div>
                                        <div id="fatherInfo" class="text-sm"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 모개체 선택 -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">🔴 모개체 (암컷) *</label>
                                <select id="babyMother" class="input-field" required onchange="updateParentPreview('mother')">
                                    ${femaleOptions}
                                </select>
                                <div id="motherPreview" class="mt-2 p-3 bg-pink-50 rounded-lg hidden">
                                    <div class="flex items-center gap-3">
                                        <div id="motherImage" class="w-12 h-12 bg-gray-200 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-female text-pink-500"></i>
                                        </div>
                                        <div id="motherInfo" class="text-sm"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 예상 모프 -->
                            <div id="expectedMorphPreview" class="mt-4 p-3 bg-purple-50 rounded-lg hidden">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-dna text-purple-500"></i>
                                    <span class="text-sm font-medium">예상 베이비 모프:</span>
                                    <span id="expectedMorph" class="text-purple-700 font-semibold"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 베이비 정보 -->
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                <i class="fas fa-egg text-yellow-500"></i>
                                베이비 정보
                            </h3>
                            
                            <!-- 알 선택 (1개 또는 2개) -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">이번 산란 알 개수 *</label>
                                <div class="flex gap-3">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="radio" name="eggCount" value="1" checked onchange="updateEggFields()">
                                        <span class="ml-2">🥚 1개</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="radio" name="eggCount" value="2" onchange="updateEggFields()">
                                        <span class="ml-2">🥚🥚 2개</span>
                                    </label>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">크레스티드 게코는 회차당 1-2개 알을 낳습니다</p>
                            </div>
                            
                            <div class="grid grid-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">해칭일 *</label>
                                    <input type="date" id="babyHatchDate" class="input-field" required onchange="updateBabyIds()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">예상 모프</label>
                                    <input type="text" id="babyMorph" class="input-field" readonly
                                           placeholder="부모 모프 기반 자동 추정">
                                </div>
                            </div>
                            
                            <!-- 베이비 1 정보 -->
                            <div id="baby1Info" class="mt-6 p-4 bg-blue-50 rounded-lg">
                                <h4 class="font-medium mb-3 flex items-center gap-2">
                                    <span class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs">1</span>
                                    첫 번째 베이비
                                </h4>
                                <div class="grid grid-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">베이비 고유 ID (자동 생성)</label>
                                        <input type="text" id="baby1Name" class="input-field bg-gray-100" readonly
                                               placeholder="부모이니셜-번호">
                                        <p class="text-xs text-gray-500 mt-1">부모 선택 시 연속 번호로 자동 생성됩니다</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">초기 체중 (g)</label>
                                        <input type="number" id="baby1Weight" class="input-field" 
                                               step="0.1" placeholder="1.5">
                                    </div>
                                </div>
                                
                                <!-- 베이비 1 사진 -->
                                <div class="mt-4">
                                    <label class="block text-sm font-medium mb-2">베이비 사진</label>
                                    <div class="image-upload-area" onclick="document.getElementById('baby1ImageInput').click()">
                                        <input type="file" id="baby1ImageInput" accept="image/*" style="display:none" onchange="previewBabyIndividualImage(this, 1)">
                                        <div id="baby1ImagePreview" style="display:none">
                                            <img id="baby1PreviewImg" class="preview-image">
                                            <button type="button" onclick="removeBabyIndividualImage(1)" class="remove-image-btn">
                                                <i class="fas fa-trash"></i> 삭제
                                            </button>
                                        </div>
                                        <div id="baby1ImageUploader">
                                            <i class="fas fa-camera text-2xl text-gray-400 mb-1"></i>
                                            <p class="text-gray-600 text-sm">사진 추가</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 베이비 2 정보 (기본 숨김) -->
                            <div id="baby2Info" class="mt-4 p-4 bg-pink-50 rounded-lg hidden">
                                <h4 class="font-medium mb-3 flex items-center gap-2">
                                    <span class="w-6 h-6 bg-pink-500 text-white rounded-full flex items-center justify-center text-xs">2</span>
                                    두 번째 베이비
                                </h4>
                                <div class="grid grid-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">베이비 고유 ID (자동 생성)</label>
                                        <input type="text" id="baby2Name" class="input-field bg-gray-100" readonly
                                               placeholder="부모이니셜-번호">
                                        <p class="text-xs text-gray-500 mt-1">부모 선택 시 연속 번호로 자동 생성됩니다</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">초기 체중 (g)</label>
                                        <input type="number" id="baby2Weight" class="input-field" 
                                               step="0.1" placeholder="1.3">
                                    </div>
                                </div>
                                
                                <!-- 베이비 2 사진 -->
                                <div class="mt-4">
                                    <label class="block text-sm font-medium mb-2">베이비 사진</label>
                                    <div class="image-upload-area" onclick="document.getElementById('baby2ImageInput').click()">
                                        <input type="file" id="baby2ImageInput" accept="image/*" style="display:none" onchange="previewBabyIndividualImage(this, 2)">
                                        <div id="baby2ImagePreview" style="display:none">
                                            <img id="baby2PreviewImg" class="preview-image">
                                            <button type="button" onclick="removeBabyIndividualImage(2)" class="remove-image-btn">
                                                <i class="fas fa-trash"></i> 삭제
                                            </button>
                                        </div>
                                        <div id="baby2ImageUploader">
                                            <i class="fas fa-camera text-2xl text-gray-400 mb-1"></i>
                                            <p class="text-gray-600 text-sm">사진 추가</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        
                        <!-- 추가 정보 -->
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                                <i class="fas fa-clipboard text-blue-500"></i>
                                추가 정보
                            </h3>
                            <div>
                                <label class="block text-sm font-medium mb-2">메모</label>
                                <textarea id="babyNotes" class="input-field" rows="3"
                                          placeholder="해칭 상태, 특이사항 등..."></textarea>
                            </div>
                        </div>
                        
                        <!-- 버튼 -->
                        <div class="flex gap-3">
                            <button type="button" onclick="closeModal()" class="btn btn-secondary flex-1">
                                <i class="fas fa-times"></i> 취소
                            </button>
                            <button type="submit" class="btn btn-primary flex-1">
                                <i class="fas fa-baby"></i> 베이비 등록
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            // 현재 날짜를 기본값으로 설정
            document.getElementById('babyHatchDate').value = new Date().toISOString().split('T')[0];
            
            openModal();
            
            // 모달 열린 후 초기 베이비 ID 생성
            setTimeout(() => {
                updateBabyIds();
            }, 200);
        }
        
        // 베이비 회차별 ID 자동 생성 함수
        function generateBabyAutoId(fatherName, motherName, index) {
            if (!fatherName || !motherName) {
                return `??-${(index + 1).toString().padStart(2, '0')}`;
            }
            
            // 부모 이름의 첫 글자 추출 (한글/영문 모두 지원)
            const fatherInitial = fatherName.charAt(0);
            const motherInitial = motherName.charAt(0);
            
            // 같은 부모 조합의 기존 베이비 수 확인
            const parentPair = `${fatherInitial}${motherInitial}`;
            const existingBabies = babies.filter(baby => 
                baby.name && baby.name.startsWith(parentPair + '-')
            );
            
            const nextNumber = existingBabies.length + index + 1;
            const candidateId = `${parentPair}-${nextNumber.toString().padStart(2, '0')}`;
            
            // 중복 확인 및 조정
            let finalNumber = nextNumber;
            let finalId = candidateId;
            
            while (babies.some(baby => baby.name === finalId || baby.babyId === finalId)) {
                finalNumber++;
                finalId = `${parentPair}-${finalNumber.toString().padStart(2, '0')}`;
            }
            
            return finalId;
        }
        
        // 베이비 ID 자동 업데이트 함수
        function updateBabyIds() {
            const fatherId = document.getElementById('babyFather').value;
            const motherId = document.getElementById('babyMother').value;
            const eggCount = parseInt(document.querySelector('input[name="eggCount"]:checked').value);
            
            let father = null, mother = null;
            if (fatherId && motherId) {
                father = animals.find(a => a.id === fatherId);
                mother = animals.find(a => a.id === motherId);
            }
            
            // 각 베이비 ID 생성
            for (let i = 0; i < eggCount; i++) {
                const babyNameField = document.getElementById(`baby${i+1}Name`);
                if (babyNameField) {
                    const autoId = generateBabyAutoId(
                        father ? father.name : '',
                        mother ? mother.name : '',
                        i
                    );
                    babyNameField.value = autoId;
                }
            }
        }
        
        // 알 개수 선택에 따른 UI 업데이트
        function updateEggFields() {
            const eggCount = document.querySelector('input[name="eggCount"]:checked').value;
            const baby2Info = document.getElementById('baby2Info');
            const baby2Name = document.getElementById('baby2Name');
            
            if (eggCount === '2') {
                baby2Info.classList.remove('hidden');
                baby2Name.required = true;
            } else {
                baby2Info.classList.add('hidden');
                baby2Name.required = false;
                baby2Name.value = '';
                document.getElementById('baby2Weight').value = '';
                // 베이비 2 이미지도 초기화
                removeBabyIndividualImage(2);
            }
            
            // 베이비 ID 업데이트
            setTimeout(updateBabyIds, 100);
        }
        
        // 베이비 등록 함수 (개선)
        async function registerBaby(event) {
            event.preventDefault();
            
            // 배열 안전성 확보
            ensureArrays();
            
            const fatherId = document.getElementById('babyFather').value;
            const motherId = document.getElementById('babyMother').value;
            const eggCount = parseInt(document.querySelector('input[name="eggCount"]:checked').value);
            
            // 부모 검증
            if (!fatherId || !motherId) {
                showToast('부모 개체를 모두 선택해주세요!', 'error');
                console.log('❌ 부모 선택 오류 - fatherId:', fatherId, 'motherId:', motherId);
                return;
            }
            
            const father = animals.find(a => a.id === fatherId);
            const mother = animals.find(a => a.id === motherId);
            
            if (!father || !mother) {
                showToast('선택한 부모 개체를 찾을 수 없습니다!', 'error');
                console.log('❌ 부모 개체 찾기 실패 - father:', father, 'mother:', mother);
                return;
            }
            
            // 부모 성별 검증
            if (father.gender !== '수컷') {
                showToast('부개체는 수컷이어야 합니다!', 'error');
                return;
            }
            
            if (mother.gender !== '암컷') {
                showToast('모개체는 암컷이어야 합니다!', 'error');
                return;
            }
            
            // 같은 개체 선택 방지
            if (father.id === mother.id) {
                showToast('부모는 서로 다른 개체여야 합니다!', 'error');
                return;
            }
            
            console.log('✅ 부모 검증 완료:', { father: father.name, mother: mother.name });
            
            // 베이비 ID 생성 함수
            function generateBabyId(hatchDate, index) {
                const date = new Date(hatchDate);
                const year = date.getFullYear().toString().slice(-2);
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                const fatherInitial = father.name.charAt(0).toUpperCase();
                const motherInitial = mother.name.charAt(0).toUpperCase();
                const number = (index + 1).toString().padStart(2, '0');
                
                return `${year}${month}${day}-${fatherInitial}${motherInitial}-${number}`;
            }
            
            // 개별 베이비 등록
            for (let i = 0; i < eggCount; i++) {
                const babyName = document.getElementById(`baby${i+1}Name`).value;
                const babyWeight = document.getElementById(`baby${i+1}Weight`).value;
                const imageInput = document.getElementById(`baby${i+1}ImageInput`);
                
                // 자동 생성된 ID이므로 검증 불필요 (기본값이라도 진행)
                if (!babyName) {
                    // 베이비 ID가 없으면 임시로 생성
                    const autoId = generateBabyAutoId(
                        father ? father.name : 'Unknown',
                        mother ? mother.name : 'Unknown',
                        i
                    );
                    document.getElementById(`baby${i+1}Name`).value = autoId;
                }
                
                const finalBabyName = babyName || document.getElementById(`baby${i+1}Name`).value;
                
                // 개별 베이비 이미지 처리
                let babyImageData = null;
                if (imageInput && imageInput.files && imageInput.files[0]) {
                    try {
                        showToast(`${i+1}번째 베이비 이미지 처리 중...`, 'info');
                        babyImageData = await compressImage(imageInput.files[0]);
                    } catch (error) {
                        console.error(`베이비 ${i+1} 이미지 처리 실패:`, error);
                        showToast(`${i+1}번째 베이비 이미지 처리에 실패했습니다. 계속 진행합니다.`, 'warning');
                    }
                }
                
                const newBaby = {
                    id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                    babyId: finalBabyName, // 자동 생성된 고유 ID를 babyId로 사용
                    name: finalBabyName,
                    fatherId: fatherId,
                    motherId: motherId,
                    fatherName: father.name,
                    motherName: mother.name,
                    hatchDate: document.getElementById('babyHatchDate').value,
                    weight: babyWeight || '',
                    morph: document.getElementById('babyMorph').value || 'TBD',
                    notes: document.getElementById('babyNotes').value,
                    status: '베이비',
                    gender: '미구분',
                    imageData: babyImageData, // 개별 베이비 이미지
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    growthRecords: [
                        {
                            date: document.getElementById('babyHatchDate').value,
                            weight: babyWeight || '',
                            notes: `해칭 - ${finalBabyName}`,
                            milestone: 'hatch',
                            image: babyImageData // 해칭 시점 개별 이미지
                        }
                    ]
                };
                
                babies.push(newBaby);
                console.log(`👶 베이비 ${finalBabyName} 등록:`, newBaby);
            }
            
            console.log(`💾 베이비 등록 전 배열 크기: ${babies.length}`);
            console.log('전체 베이비 배열:', babies);
            
            // 데이터 저장
            saveData();
            
            // 저장 후 확인
            console.log('💾 저장 후 localStorage 확인:');
            console.log('- babies 키:', localStorage.getItem('babies') ? JSON.parse(localStorage.getItem('babies')).length + '개' : '없음');
            console.log('- geckoBabies 키:', localStorage.getItem('geckoBabies') ? JSON.parse(localStorage.getItem('geckoBabies')).length + '개' : '없음');
            
            // UI 업데이트
            updateStatistics();
            
            // Firebase 동기화
            if (window.firebaseSync && window.firebaseSync.isInitialized) {
                window.firebaseSync.saveToCloud('babies', babies);
                console.log('☁️ Firebase 동기화 시작');
            }
            
            closeModal();
            const babyNames = Array.from({length: eggCount}, (_, i) => 
                document.getElementById(`baby${i+1}Name`).value
            ).join(', ');
            showToast(`베이비 ${babyNames}가 등록되었습니다! (총 ${eggCount}마리)`, 'success');
            console.log(`✅ 새 베이비 ${eggCount}마리 등록 완료:`, babyNames);
            
            // 즉시 베이비 목록 모달 표시 (지연 시간 제거)
            setTimeout(() => {
                console.log('📋 베이비 목록 모달 표시 시작...');
                showBabyListModal();
            }, 100);
        }
        
        // 개별 베이비 이미지 미리보기 함수
        function previewBabyIndividualImage(input, babyIndex) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById(`baby${babyIndex}PreviewImg`).src = e.target.result;
                    document.getElementById(`baby${babyIndex}ImagePreview`).style.display = 'block';
                    document.getElementById(`baby${babyIndex}ImageUploader`).style.display = 'none';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // 개별 베이비 이미지 제거 함수
        function removeBabyIndividualImage(babyIndex) {
            document.getElementById(`baby${babyIndex}ImageInput`).value = '';
            document.getElementById(`baby${babyIndex}ImagePreview`).style.display = 'none';
            document.getElementById(`baby${babyIndex}ImageUploader`).style.display = 'block';
        }
        
        // 이미지를 Base64로 압축하는 함수
        function compressImage(file, maxWidth = 300, quality = 0.7) {
            return new Promise((resolve, reject) => {
                try {
                    // 파일 유효성 검증
                    if (!file || !file.type.startsWith('image/')) {
                        reject(new Error('유효한 이미지 파일이 아닙니다.'));
                        return;
                    }
                    
                    // 파일 크기 제한 (10MB)
                    if (file.size > 10 * 1024 * 1024) {
                        reject(new Error('이미지 파일이 너무 큽니다. (최대 10MB)'));
                        return;
                    }
                    
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = function() {
                        try {
                            // 비율 유지하며 리사이즈
                            const ratio = Math.min(maxWidth / img.width, maxWidth / img.height);
                            const newWidth = img.width * ratio;
                            const newHeight = img.height * ratio;
                            
                            canvas.width = newWidth;
                            canvas.height = newHeight;
                            
                            // 이미지 그리기
                            ctx.drawImage(img, 0, 0, newWidth, newHeight);
                            
                            // Base64로 변환 (압축)
                            const compressedData = canvas.toDataURL('image/jpeg', quality);
                            
                            // URL 객체 정리
                            URL.revokeObjectURL(img.src);
                            
                            resolve(compressedData);
                        } catch (error) {
                            reject(new Error('이미지 처리 중 오류가 발생했습니다: ' + error.message));
                        }
                    };
                    
                    img.onerror = function() {
                        reject(new Error('이미지 로드에 실패했습니다.'));
                    };
                    
                    img.src = URL.createObjectURL(file);
                    
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        // 베이비 목록 데이터 새로고침 (강화된 디버깅)
        function refreshBabyData() {
            console.log('🔄 베이비 데이터 새로고침 시작...');
            
            // 모든 가능한 키에서 베이비 데이터 찾기
            const babyKeys = ['babies', 'geckoBabies'];
            let foundData = false;
            
            for (const key of babyKeys) {
                const savedData = localStorage.getItem(key);
                
                if (savedData) {
                    try {
                        const parsedData = JSON.parse(savedData);
                        console.log(`📦 키 "${key}" 확인: ${parsedData.length}개 발견`);
                        
                        if (Array.isArray(parsedData) && parsedData.length > 0) {
                            babies = parsedData;
                            foundData = true;
                            console.log(`✅ "${key}"에서 ${babies.length}마리 베이비 로드 성공`);
                            break;
                        }
                    } catch (error) {
                        console.error(`❌ 키 "${key}" 파싱 실패:`, error);
                    }
                } else {
                    console.log(`📦 키 "${key}" 확인: 데이터 없음`);
                }
            }
            
            if (!foundData) {
                console.warn('⚠️ 베이비 데이터를 찾을 수 없음 - 빈 배열로 초기화');
                babies = [];
            }
            
            console.log(`📊 최종 베이비 데이터: ${babies.length}마리`);
            console.log('베이비 목록:', babies);
        }
        
        // 베이비 목록 추가 (주요 기능에 추가하기 위함)
        function showBabyListModal() {
            // 배열 안전성 확보
            ensureArrays();
            console.log('📋 베이비 목록 모달 시작 - 현재 babies 배열:', babies.length + '마리');
            
            // 데이터 새로고침
            refreshBabyData();
            
            console.log('🔄 새로고침 후 babies 배열:', babies.length + '마리');
            
            const modalContent = document.getElementById('modalContent');
            let listHTML = '';
            
            if (!babies || babies.length === 0) {
                console.log('⚠️ 베이비 데이터가 없음 - 빈 상태 표시');
                listHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-baby text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">등록된 베이비가 없습니다</p>
                        <button onclick="closeModal(); showBabyModal();" class="btn btn-primary mt-4">
                            <i class="fas fa-plus"></i> 첫 베이비 등록하기
                        </button>
                    </div>
                `;
            } else {
                console.log(`✅ ${babies.length}마리 베이비 목록 생성 시작`);
                listHTML = `
                    <div class="grid gap-4">
                        ${babies.map(baby => {
                            const age = Math.floor((new Date() - new Date(baby.hatchDate)) / (1000 * 60 * 60 * 24));
                            return `
                                <div class="glass-card p-4 hover:bg-white/50 transition-colors">
                                    <div class="flex gap-4">
                                        <!-- 베이비 이미지 -->
                                        <div class="flex-shrink-0">
                                            ${baby.imageData ? 
                                                `<img src="${baby.imageData}" alt="${baby.babyId}" class="w-20 h-20 object-cover rounded-lg border-2 border-gray-200">` :
                                                `<div class="w-20 h-20 bg-gray-100 rounded-lg border-2 border-gray-200 flex items-center justify-content">
                                                    <i class="fas fa-camera text-gray-400 text-lg mx-auto"></i>
                                                </div>`
                                            }
                                        </div>
                                        
                                        <!-- 베이비 정보 -->
                                        <div class="flex-1">
                                            <h4 class="font-semibold text-lg">${baby.name || baby.babyId}</h4>
                                            <div class="text-sm text-gray-600 mt-1">
                                                <span class="mr-4">👨 ${baby.fatherName} × 👩 ${baby.motherName}</span>
                                                <span class="text-purple-600 font-medium">${baby.morph || 'TBD'}</span>
                                            </div>
                                            ${baby.name ? `<div class="text-xs text-gray-500">ID: ${baby.babyId}</div>` : ''}
                                            <div class="text-sm text-gray-500 mt-1">
                                                🥚 해칭: ${baby.hatchDate} (${age}일차)
                                                ${baby.weight ? ` • ⚖️ ${baby.weight}g` : ' • ⚖️ 미기록'}
                                            </div>
                                            ${baby.notes ? `<p class="text-sm text-gray-600 mt-1">${baby.notes}</p>` : ''}
                                        </div>
                                        
                                        <!-- 상태 및 액션 -->
                                        <div class="text-right flex-shrink-0">
                                            <span class="inline-block px-2 py-1 bg-pink-100 text-pink-800 text-xs rounded-full mb-2">
                                                ${baby.status}
                                            </span>
                                            <div class="flex flex-col gap-1">
                                                <button onclick="showBabyDetails('${baby.id}')" 
                                                        class="text-xs text-purple-600 hover:text-purple-800 px-2 py-1 rounded">
                                                    상세보기
                                                </button>
                                                <button onclick="showBabyGrowthModal('${baby.id}')" 
                                                        class="text-xs text-green-600 hover:text-green-800 px-2 py-1 rounded">
                                                    성장기록
                                                </button>
                                                <button onclick="promoteToF2('${baby.id}')" 
                                                        class="text-xs text-blue-600 hover:text-blue-800 px-2 py-1 rounded">
                                                    F2 승격
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            modalContent.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold flex items-center gap-2">
                            <i class="fas fa-baby text-pink-500"></i>
                            베이비 목록 (${babies.length}마리)
                        </h2>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- 검색 및 필터링 -->
                    <div class="glass-card p-4 mb-6">
                        <div class="flex gap-4 items-center">
                            <div class="flex-1">
                                <input type="text" id="babySearch" placeholder="베이비 ID, 부모명, 모프로 검색..." 
                                       class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       oninput="filterBabies()">
                            </div>
                            <div>
                                <select id="babyStatusFilter" class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="filterBabies()">
                                    <option value="">전체 상태</option>
                                    <option value="베이비">베이비</option>
                                    <option value="활성">성체</option>
                                </select>
                            </div>
                            <div>
                                <select id="babyAgeFilter" class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="filterBabies()">
                                    <option value="">전체 연령</option>
                                    <option value="0-30">1개월 미만</option>
                                    <option value="30-90">1-3개월</option>
                                    <option value="90-180">3-6개월</option>
                                    <option value="180+">6개월 이상</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div id="babyListContainer">
                        ${listHTML}
                    </div>
                </div>
            `;
            openModal();
        }
        
        // 베이비 필터링 및 검색 함수
        function filterBabies() {
            const searchTerm = document.getElementById('babySearch').value.toLowerCase();
            const statusFilter = document.getElementById('babyStatusFilter').value;
            const ageFilter = document.getElementById('babyAgeFilter').value;
            
            let filteredBabies = babies.filter(baby => {
                // 검색어 필터링
                const matchesSearch = !searchTerm || 
                    (baby.name && baby.name.toLowerCase().includes(searchTerm)) ||
                    baby.babyId.toLowerCase().includes(searchTerm) ||
                    baby.fatherName.toLowerCase().includes(searchTerm) ||
                    baby.motherName.toLowerCase().includes(searchTerm) ||
                    (baby.morph && baby.morph.toLowerCase().includes(searchTerm));
                
                // 상태 필터링
                const matchesStatus = !statusFilter || baby.status === statusFilter;
                
                // 연령 필터링
                let matchesAge = true;
                if (ageFilter) {
                    const age = Math.floor((new Date() - new Date(baby.hatchDate)) / (1000 * 60 * 60 * 24));
                    if (ageFilter === '0-30') matchesAge = age < 30;
                    else if (ageFilter === '30-90') matchesAge = age >= 30 && age < 90;
                    else if (ageFilter === '90-180') matchesAge = age >= 90 && age < 180;
                    else if (ageFilter === '180+') matchesAge = age >= 180;
                }
                
                return matchesSearch && matchesStatus && matchesAge;
            });
            
            // 필터링된 결과로 목록 업데이트
            updateBabyList(filteredBabies);
        }
        
        // 베이비 목록 업데이트 함수
        function updateBabyList(babiesToShow) {
            const container = document.getElementById('babyListContainer');
            
            if (babiesToShow.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">검색 조건에 맞는 베이비가 없습니다</p>
                        <button onclick="clearBabyFilters()" class="btn btn-primary mt-4">
                            <i class="fas fa-times"></i> 필터 초기화
                        </button>
                    </div>
                `;
                return;
            }
            
            const listHTML = `
                <div class="grid gap-4">
                    ${babiesToShow.map(baby => {
                        const age = Math.floor((new Date() - new Date(baby.hatchDate)) / (1000 * 60 * 60 * 24));
                        const growthProgress = calculateGrowthProgress(baby);
                        
                        return `
                            <div class="glass-card p-4 hover:bg-white/50 transition-colors">
                                <div class="flex gap-4">
                                    <!-- 베이비 이미지 -->
                                    <div class="flex-shrink-0">
                                        ${baby.imageData ? 
                                            `<img src="${baby.imageData}" alt="${baby.babyId}" class="w-20 h-20 object-cover rounded-lg border-2 border-gray-200">` :
                                            `<div class="w-20 h-20 bg-gray-100 rounded-lg border-2 border-gray-200 flex items-center justify-center">
                                                <i class="fas fa-camera text-gray-400 text-lg mx-auto"></i>
                                            </div>`
                                        }
                                    </div>
                                    
                                    <!-- 베이비 정보 -->
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-lg">${baby.name || baby.babyId}</h4>
                                        <div class="text-sm text-gray-600 mt-1">
                                            <span class="mr-4">👨 ${baby.fatherName} × 👩 ${baby.motherName}</span>
                                            <span class="text-purple-600 font-medium">${baby.morph || 'TBD'}</span>
                                        </div>
                                        ${baby.name ? `<div class="text-xs text-gray-500">ID: ${baby.babyId}</div>` : ''}
                                        <div class="text-sm text-gray-500 mt-1">
                                            🥚 해칭: ${baby.hatchDate} (${age}일차)
                                            ${baby.weight ? ` • ⚖️ ${baby.weight}g` : ' • ⚖️ 미기록'}
                                        </div>
                                        ${baby.notes ? `<p class="text-sm text-gray-600 mt-1">${baby.notes}</p>` : ''}
                                        
                                        <!-- 성장 진행률 -->
                                        <div class="mt-2">
                                            <div class="flex items-center gap-2 mb-1">
                                                <span class="text-xs text-gray-500">성장 기록:</span>
                                                <span class="text-xs font-medium text-blue-600">${growthProgress.recorded}/${growthProgress.total}</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-2">
                                                <div class="bg-blue-500 h-2 rounded-full" style="width: ${(growthProgress.recorded / growthProgress.total) * 100}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 상태 및 액션 -->
                                    <div class="text-right flex-shrink-0">
                                        <span class="inline-block px-2 py-1 bg-pink-100 text-pink-800 text-xs rounded-full mb-2">
                                            ${baby.status}
                                        </span>
                                        <div class="flex flex-col gap-1">
                                            <button onclick="showBabyDetails('${baby.id}')" 
                                                    class="text-xs text-purple-600 hover:text-purple-800 px-2 py-1 rounded">
                                                상세보기
                                            </button>
                                            <button onclick="showBabyGrowthModal('${baby.id}')" 
                                                    class="text-xs text-green-600 hover:text-green-800 px-2 py-1 rounded">
                                                성장기록
                                            </button>
                                            <button onclick="promoteToF2('${baby.id}')" 
                                                    class="text-xs text-blue-600 hover:text-blue-800 px-2 py-1 rounded">
                                                F2 승격
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            container.innerHTML = listHTML;
        }
        
        // 성장 진행률 계산 함수 (체중 기반)
        function calculateGrowthProgress(baby) {
            const weightMilestones = [
                { stage: '1g', weight: 1 },
                { stage: '5g', weight: 5 },
                { stage: '10g', weight: 10 },
                { stage: '15g', weight: 15 },
                { stage: '20g', weight: 20 },
                { stage: '25g', weight: 25 },
                { stage: '30g', weight: 30 },
                { stage: '35g', weight: 35 }
            ];
            
            // 현재 체중 파악 (가장 최근 기록)
            let currentWeight = 0;
            if (baby.growthRecords && baby.growthRecords.length > 0) {
                const latestRecord = baby.growthRecords
                    .filter(r => r.weight && parseFloat(r.weight) > 0)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                currentWeight = latestRecord ? parseFloat(latestRecord.weight) : 0;
            }
            
            const availableMilestones = weightMilestones.filter(m => currentWeight >= m.weight);
            const recordedMilestones = availableMilestones.filter(m => 
                baby.growthRecords.some(r => r.milestone === m.stage)
            );
            
            return {
                total: Math.max(availableMilestones.length, 1), // 최소 1개
                recorded: recordedMilestones.length
            };
        }
        
        // 필터 초기화 함수
        function clearBabyFilters() {
            document.getElementById('babySearch').value = '';
            document.getElementById('babyStatusFilter').value = '';
            document.getElementById('babyAgeFilter').value = '';
            updateBabyList(babies);
        }
        
        // 베이비를 성체로 승격
        function promoteToF2(babyId) {
            const baby = babies.find(b => b.id === babyId);
            if (!baby) return;
            
            // 성별이 미구분인 경우 성별을 먼저 확인
            if (!baby.gender || baby.gender === '미구분') {
                const genderChoice = confirm(`${baby.name || baby.babyId}의 성별을 먼저 확인해야 합니다.\n\n확인을 누르면 수컷, 취소를 누르면 암컷으로 설정됩니다.`);
                baby.gender = genderChoice ? '수컷' : '암컷';
                saveData();
                showToast(`성별이 "${baby.gender}"로 설정되었습니다.`, 'info');
            }
            
            if (confirm(`${baby.name || baby.babyId}를 F2 세대로 승격하시겠습니까?\n\n성별: ${baby.gender}\n성체 개체로 등록되어 번식에 사용할 수 있습니다.`)) {
                // 베이비를 F2 성체 배열로 이동
                const newF2Adult = {
                    id: baby.id,
                    name: baby.name || baby.babyId,
                    gender: baby.gender, // 베이비의 확정된 성별 사용
                    generation: 'F2',
                    morph: baby.morph || 'TBD',
                    weight: baby.weight || '',
                    birthDate: baby.hatchDate,
                    date: baby.hatchDate, // 호환성을 위한 date 필드도 추가
                    notes: `${baby.fatherName} × ${baby.motherName}에서 F2 승격. ${baby.notes || ''}`,
                    status: '활성',
                    imageData: baby.imageData,
                    createdAt: baby.createdAt,
                    updatedAt: new Date().toISOString(),
                    promotedAt: new Date().toISOString(),
                    growthRecords: baby.growthRecords || []
                };
                
                animals.push(newF2Adult);
                babies.splice(babies.findIndex(b => b.id === babyId), 1);
                
                saveData();
                showBabyListModal(); // 목록 새로고침
                showToast(`${baby.name || baby.babyId}가 F2 ${baby.gender}로 승격되었습니다! 이제 번식에 사용할 수 있습니다.`, 'success');
            }
        }
        
        // 베이비 성장 기록 모달
        function showBabyGrowthModal(babyId) {
            const baby = babies.find(b => b.id === babyId);
            if (!baby) return;
            
            const modalContent = document.getElementById('modalContent');
            const age = Math.floor((new Date() - new Date(baby.hatchDate)) / (1000 * 60 * 60 * 24));
            
            // 체중 기반 성장 마일스톤 정의
            const milestones = [
                { stage: 'hatch', name: '해칭', weight: 0, icon: 'fas fa-egg', color: 'yellow' },
                { stage: '1g', name: '1g 달성', weight: 1, icon: 'fas fa-seedling', color: 'green' },
                { stage: '5g', name: '5g 달성', weight: 5, icon: 'fas fa-leaf', color: 'green' },
                { stage: '10g', name: '10g 달성', weight: 10, icon: 'fas fa-tree', color: 'emerald' },
                { stage: '15g', name: '15g 달성', weight: 15, icon: 'fas fa-crown', color: 'blue' },
                { stage: '20g', name: '20g 달성', weight: 20, icon: 'fas fa-star', color: 'purple' },
                { stage: '25g', name: '25g 달성', weight: 25, icon: 'fas fa-trophy', color: 'orange' },
                { stage: '30g', name: '30g 달성', weight: 30, icon: 'fas fa-medal', color: 'red' },
                { stage: '35g', name: '35g+ 달성', weight: 35, icon: 'fas fa-gem', color: 'pink' }
            ];
            
            // 현재 체중 파악
            let currentWeight = 0;
            if (baby.growthRecords && baby.growthRecords.length > 0) {
                const latestRecord = baby.growthRecords
                    .filter(r => r.weight && parseFloat(r.weight) > 0)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                currentWeight = latestRecord ? parseFloat(latestRecord.weight) : 0;
            }
            
            let milestonesHTML = '';
            milestones.forEach(milestone => {
                const record = baby.growthRecords.find(r => r.milestone === milestone.stage);
                const isAvailable = milestone.stage === 'hatch' || currentWeight >= milestone.weight;
                
                milestonesHTML += `
                    <div class="glass-card p-4 ${isAvailable ? 'cursor-pointer hover:bg-blue-50' : 'opacity-50'}" 
                         ${isAvailable ? `onclick="showGrowthRecordForm('${babyId}', '${milestone.stage}')"` : ''}>
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full ${record ? 'bg-green-100' : 'bg-gray-100'} flex items-center justify-center">
                                <i class="${milestone.icon} ${record ? 'text-green-600' : 'text-gray-400'}"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-semibold">${milestone.name}</h4>
                                ${record ? 
                                    `<p class="text-sm text-green-600">✓ 기록됨 (${record.date}) ${record.weight ? record.weight + 'g' : ''}</p>` : 
                                    `<p class="text-sm text-gray-500">${isAvailable ? '기록 추가 가능' : `현재 체중 ${currentWeight}g (${milestone.weight}g 필요)`}</p>`
                                }
                            </div>
                            ${record && record.image ? 
                                `<img src="${record.image}" class="w-16 h-16 object-cover rounded-lg border">` : 
                                `<div class="w-16 h-16 bg-gray-100 rounded-lg border flex items-center justify-center">
                                    <i class="fas fa-camera text-gray-400"></i>
                                </div>`
                            }
                        </div>
                        ${record && record.notes ? `<p class="text-sm text-gray-600 mt-2 ml-15">${record.notes}</p>` : ''}
                        ${record && record.weight ? `<p class="text-sm text-blue-600 mt-1 ml-15">체중: ${record.weight}g</p>` : ''}
                    </div>
                `;
            });
            
            modalContent.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold flex items-center gap-2">
                            <i class="fas fa-chart-line text-green-500"></i>
                            ${baby.babyId} 성장 기록
                        </h2>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="glass-card p-4 mb-6">
                        <div class="flex items-center gap-4">
                            ${baby.imageData ? 
                                `<img src="${baby.imageData}" class="w-20 h-20 object-cover rounded-lg border-2">` :
                                `<div class="w-20 h-20 bg-gray-100 rounded-lg border-2 flex items-center justify-center">
                                    <i class="fas fa-camera text-gray-400 text-xl"></i>
                                </div>`
                            }
                            <div>
                                <h3 class="text-xl font-semibold">${baby.babyId}</h3>
                                <p class="text-gray-600">${baby.fatherName} × ${baby.motherName}</p>
                                <p class="text-sm text-gray-500">해칭: ${baby.hatchDate} (${age}일)</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold mb-4">성장 마일스톤</h3>
                        ${milestonesHTML}
                    </div>
                </div>
            `;
            
            openModal();
        }
        
        // 성장 기록 입력 폼
        function showGrowthRecordForm(babyId, milestone) {
            const baby = babies.find(b => b.id === babyId);
            if (!baby) return;
            
            const existingRecord = baby.growthRecords.find(r => r.milestone === milestone);
            const modalContent = document.getElementById('modalContent');
            
            modalContent.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold flex items-center gap-2">
                            <i class="fas fa-plus-circle text-blue-500"></i>
                            ${milestone} 성장 기록 ${existingRecord ? '수정' : '추가'}
                        </h2>
                        <button onclick="showBabyGrowthModal('${babyId}')" class="text-gray-400 hover:text-gray-600 text-2xl">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                    </div>
                    
                    <form onsubmit="saveGrowthRecord(event, '${babyId}', '${milestone}')" class="space-y-6">
                        <!-- 기본 정보 -->
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-semibold mb-4">기록 정보</h3>
                            <div class="grid grid-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">기록 날짜 *</label>
                                    <input type="date" id="recordDate" class="input-field" required
                                           value="${existingRecord ? existingRecord.date : new Date().toISOString().split('T')[0]}">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">체중 (g)</label>
                                    <input type="number" id="recordWeight" class="input-field" step="0.1"
                                           value="${existingRecord ? existingRecord.weight || '' : ''}"
                                           placeholder="예: 5.2">
                                </div>
                            </div>
                        </div>
                        
                        <!-- 성장 이미지 -->
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-semibold mb-4">성장 사진</h3>
                            <div class="image-upload-area" onclick="document.getElementById('growthImageInput').click()">
                                <input type="file" id="growthImageInput" accept="image/*" style="display:none" onchange="previewGrowthImage(this)">
                                <div id="growthImagePreview" style="${existingRecord && existingRecord.image ? 'display:block' : 'display:none'}">
                                    <img id="growthPreviewImg" class="preview-image" 
                                         src="${existingRecord && existingRecord.image ? existingRecord.image : ''}">
                                    <button type="button" onclick="removeGrowthImage()" class="remove-image-btn">
                                        <i class="fas fa-trash"></i> 이미지 삭제
                                    </button>
                                </div>
                                <div id="growthImageUploader" style="${existingRecord && existingRecord.image ? 'display:none' : 'display:block'}">
                                    <i class="fas fa-camera text-4xl text-gray-400 mb-2"></i>
                                    <p class="text-gray-600 font-medium">성장 사진 추가</p>
                                    <p class="text-sm text-gray-500 mt-1">${milestone} 단계 사진을 등록해주세요</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 메모 -->
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-semibold mb-4">성장 메모</h3>
                            <textarea id="recordNotes" class="input-field" rows="4"
                                      placeholder="성장 상태, 행동 변화, 특이사항 등을 기록해주세요...">${existingRecord ? existingRecord.notes || '' : ''}</textarea>
                        </div>
                        
                        <!-- 버튼 -->
                        <div class="flex gap-3">
                            <button type="button" onclick="showBabyGrowthModal('${babyId}')" class="btn btn-secondary flex-1">
                                취소
                            </button>
                            <button type="submit" class="btn btn-primary flex-1">
                                <i class="fas fa-save"></i> ${existingRecord ? '수정' : '저장'}
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            openModal();
        }
        
        // 성장 기록 저장
        async function saveGrowthRecord(event, babyId, milestone) {
            event.preventDefault();
            
            const baby = babies.find(b => b.id === babyId);
            if (!baby) return;
            
            const date = document.getElementById('recordDate').value;
            const weight = document.getElementById('recordWeight').value;
            const notes = document.getElementById('recordNotes').value;
            const imageInput = document.getElementById('growthImageInput');
            
            // 이미지 처리
            let imageData = null;
            if (imageInput.files && imageInput.files[0]) {
                try {
                    showToast('이미지 처리 중...', 'info');
                    imageData = await compressImage(imageInput.files[0]);
                } catch (error) {
                    console.error('이미지 처리 실패:', error);
                    // 기존 이미지 유지
                    const existingRecord = baby.growthRecords.find(r => r.milestone === milestone);
                    imageData = existingRecord ? existingRecord.image : null;
                }
            } else {
                // 새 이미지가 없으면 기존 이미지 유지
                const existingRecord = baby.growthRecords.find(r => r.milestone === milestone);
                imageData = existingRecord ? existingRecord.image : null;
            }
            
            // 기존 기록 찾기
            const recordIndex = baby.growthRecords.findIndex(r => r.milestone === milestone);
            
            const newRecord = {
                date: date,
                weight: weight || null,
                notes: notes || '',
                milestone: milestone,
                image: imageData,
                createdAt: new Date().toISOString()
            };
            
            if (recordIndex >= 0) {
                // 기존 기록 수정
                baby.growthRecords[recordIndex] = { ...baby.growthRecords[recordIndex], ...newRecord };
            } else {
                // 새 기록 추가
                baby.growthRecords.push(newRecord);
            }
            
            saveData();
            showBabyGrowthModal(babyId);
            showToast(`${milestone} 성장 기록이 저장되었습니다!`, 'success');
        }
        
        // 성장 이미지 미리보기 함수
        function previewGrowthImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('growthPreviewImg').src = e.target.result;
                    document.getElementById('growthImagePreview').style.display = 'block';
                    document.getElementById('growthImageUploader').style.display = 'none';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // 성장 이미지 제거 함수
        function removeGrowthImage() {
            document.getElementById('growthImageInput').value = '';
            document.getElementById('growthImagePreview').style.display = 'none';
            document.getElementById('growthImageUploader').style.display = 'block';
        }
        
        // 부모 미리보기 업데이트 함수
        function updateParentPreview(parentType) {
            const selectId = parentType === 'father' ? 'babyFather' : 'babyMother';
            const previewId = parentType === 'father' ? 'fatherPreview' : 'motherPreview';
            const imageId = parentType === 'father' ? 'fatherImage' : 'motherImage';
            const infoId = parentType === 'father' ? 'fatherInfo' : 'motherInfo';
            
            const selectedId = document.getElementById(selectId).value;
            const previewDiv = document.getElementById(previewId);
            const imageDiv = document.getElementById(imageId);
            const infoDiv = document.getElementById(infoId);
            
            if (!selectedId) {
                previewDiv.classList.add('hidden');
                return;
            }
            
            const parent = animals.find(a => a.id === selectedId);
            if (!parent) return;
            
            // 이미지 표시
            if (parent.imageData) {
                imageDiv.innerHTML = `<img src="${parent.imageData}" class="w-12 h-12 object-cover rounded-lg">`;
            } else {
                const icon = parentType === 'father' ? 'fa-male' : 'fa-female';
                const color = parentType === 'father' ? 'blue' : 'pink';
                imageDiv.innerHTML = `<i class="fas ${icon} text-${color}-500"></i>`;
            }
            
            // 정보 표시
            const birthYear = parent.birthDate ? new Date(parent.birthDate).getFullYear() : (parent.date ? new Date(parent.date).getFullYear() : '?');
            const age = parent.birthDate ? Math.floor((new Date() - new Date(parent.birthDate)) / (1000 * 60 * 60 * 24 * 365.25)) : '?';
            
            infoDiv.innerHTML = `
                <div class="font-semibold text-gray-800">${parent.name}</div>
                <div class="text-gray-600">${parent.morph || 'Normal'} | ${parent.generation || 'F1'}</div>
                <div class="text-gray-500">${birthYear}년생 (${age}세) | ${parent.weight ? parent.weight + 'g' : '체중 미기록'}</div>
            `;
            
            previewDiv.classList.remove('hidden');
            
            // 부모 정보가 변경되면 베이비 ID도 업데이트
            setTimeout(updateBabyIds, 100);
            
            // 예상 모프 업데이트
            updateExpectedMorph();
        }
        
        // 예상 모프 계산 함수
        function updateExpectedMorph() {
            const fatherId = document.getElementById('babyFather').value;
            const motherId = document.getElementById('babyMother').value;
            const expectedDiv = document.getElementById('expectedMorphPreview');
            const morphSpan = document.getElementById('expectedMorph');
            
            if (!fatherId || !motherId) {
                expectedDiv.classList.add('hidden');
                return;
            }
            
            const father = animals.find(a => a.id === fatherId);
            const mother = animals.find(a => a.id === motherId);
            
            if (!father || !mother) return;
            
            const fatherMorph = father.morph || 'Normal';
            const motherMorph = mother.morph || 'Normal';
            
            // 간단한 모프 조합 예측
            let expectedMorph = '';
            
            if (fatherMorph === motherMorph) {
                expectedMorph = fatherMorph;
            } else if (fatherMorph === 'Normal') {
                expectedMorph = `${motherMorph} (Het)`;
            } else if (motherMorph === 'Normal') {
                expectedMorph = `${fatherMorph} (Het)`;
            } else {
                expectedMorph = `${fatherMorph} x ${motherMorph}`;
            }
            
            morphSpan.textContent = expectedMorph;
            
            // 예상 모프를 베이비 모프 필드에 자동 입력
            const babyMorphField = document.getElementById('babyMorph');
            if (babyMorphField && !babyMorphField.value) {
                babyMorphField.value = expectedMorph;
            }
            
            expectedDiv.classList.remove('hidden');
        }
        
        // 인기 모프 표시 함수
        function showPopularMorphs() {
            const popularDiv = document.getElementById('popularMorphs');
            const suggestionsDiv = document.getElementById('morphSuggestions');
            
            popularDiv.classList.remove('hidden');
            suggestionsDiv.classList.add('hidden');
        }
        
        // 모프 선택 함수
        function selectMorph(morphName) {
            document.getElementById('animalMorph').value = morphName;
            document.getElementById('popularMorphs').classList.add('hidden');
            document.getElementById('morphSuggestions').classList.add('hidden');
            
            // 자동으로 ID 생성 제안
            showToast(`모프 "${morphName}" 선택됨! 자동생성 버튼을 눌러 ID를 생성하세요.`, 'info');
        }
        
        // 모프 자동완성 제안 표시
        function showMorphSuggestions(inputValue) {
            const suggestionsDiv = document.getElementById('morphSuggestions');
            const popularDiv = document.getElementById('popularMorphs');
            
            if (!inputValue.trim()) {
                suggestionsDiv.classList.add('hidden');
                popularDiv.classList.remove('hidden');
                return;
            }
            
            popularDiv.classList.add('hidden');
            
            // 기존 모프들과 매칭
            const allMorphs = [
                ...Object.keys(morphCodes),
                // 기존 개체들의 모프도 추가
                ...new Set(animals.map(a => a.morph).filter(Boolean))
            ];
            
            const matches = allMorphs.filter(morph => 
                morph.toLowerCase().includes(inputValue.toLowerCase())
            ).slice(0, 8); // 최대 8개까지
            
            if (matches.length === 0) {
                suggestionsDiv.classList.add('hidden');
                return;
            }
            
            let suggestionsHTML = '';
            matches.forEach(morph => {
                const morphCode = getMorphCode(morph);
                suggestionsHTML += `
                    <div onclick="selectMorph('${morph}')" class="px-3 py-2 hover:bg-gray-100 cursor-pointer flex justify-between items-center">
                        <span>${morph}</span>
                        <span class="text-xs text-gray-500">${morphCode}</span>
                    </div>
                `;
            });
            
            suggestionsDiv.innerHTML = suggestionsHTML;
            suggestionsDiv.classList.remove('hidden');
        }
        
        // 클릭 외부 영역 시 자동완성 숨기기
        document.addEventListener('click', function(e) {
            const morphInput = document.getElementById('animalMorph');
            const suggestionsDiv = document.getElementById('morphSuggestions');
            const popularDiv = document.getElementById('popularMorphs');
            
            // DOM 요소가 존재하고 클릭된 요소가 내부에 있지 않은 경우에만 숨기기
            if (morphInput && suggestionsDiv && popularDiv) {
                if (!morphInput.contains(e.target) && 
                    !suggestionsDiv.contains(e.target) && 
                    !popularDiv.contains(e.target)) {
                    suggestionsDiv.classList.add('hidden');
                    popularDiv.classList.add('hidden');
                }
            }
        });
        
        // 모프 계산기 모달 (기본 구조)
        function showMorphCalculatorModal() {
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold flex items-center gap-2">
                            <i class="fas fa-calculator text-purple-500"></i>
                            모프 계산기
                        </h2>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="text-center py-12">
                        <i class="fas fa-hammer text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">모프 계산기 준비 중입니다</p>
                    </div>
                </div>
            `;
            openModal();
        }
        
        // 대량 가져오기 모달 (기본 구조)
        function showBulkImportModal() {
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold flex items-center gap-2">
                            <i class="fas fa-file-import text-blue-500"></i>
                            대량 가져오기
                        </h2>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="text-center py-12">
                        <i class="fas fa-hammer text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">대량 가져오기 기능 준비 중입니다</p>
                    </div>
                </div>
            `;
            openModal();
        }
        
        // 디버깅 함수
        function debugData() {
            console.log('🔧 === 디버깅 정보 ===');
            console.log('현재 babies 배열:', babies);
            console.log('babies 배열 길이:', babies.length);
            
            // 로컬스토리지 확인
            const localBabies = localStorage.getItem('babies');
            const localGeckoBabies = localStorage.getItem('geckoBabies');
            
            console.log('localStorage - babies:', localBabies ? JSON.parse(localBabies) : 'null');
            console.log('localStorage - geckoBabies:', localGeckoBabies ? JSON.parse(localGeckoBabies) : 'null');
            
            // 통계
            updateStatistics();
            
            // 사용자에게 알림
            const babyCount = babies.length;
            const localCount = localBabies ? JSON.parse(localBabies).length : 0;
            
            alert(`🔧 디버깅 정보:
            
메모리 베이비: ${babyCount}마리
저장된 베이비: ${localCount}마리
동물 수: ${animals.length}마리

콘솔을 확인하세요!`);
        }
        
        // 토스트 알림
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-6 py-4 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full`;
            
            const colors = {
                success: 'bg-green-500 text-white',
                error: 'bg-red-500 text-white',
                warning: 'bg-yellow-500 text-white',
                info: 'bg-blue-500 text-white'
            };
            
            toast.className += ` ${colors[type] || colors.info}`;
            toast.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'}-circle"></i>
                    ${message}
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // 애니메이션
            setTimeout(() => toast.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }
    </script>
</body>
</html>